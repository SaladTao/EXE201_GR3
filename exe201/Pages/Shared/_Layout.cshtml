@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@inject exe201.Models.EcommerceContext _context

@{
	var username = HttpContextAccessor.HttpContext.Session.GetString("Username");
	bool isLoggedIn = !string.IsNullOrEmpty(username);
}

<!DOCTYPE html>
<html lang="en">
<head>
	<title>BookSaw - Free Book Store HTML CSS Template</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="format-detection" content="telephone=no">
	<meta name="apple-mobile-web-app-capable" content="yes">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" />

	<link rel="stylesheet" href="~/css/normalize.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/icomoon/icomoon.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/css/vendor.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/style.css" asp-append-version="true" />

	<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap&subset=vietnamese" rel="stylesheet">

	<style>
		.user-account-wrapper {
			position: relative;
			display: inline-block;
		}

		.account-dropdown {
			display: none;
			position: absolute;
			background-color: white;
			min-width: 150px;
			box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
			z-index: 999;
			top: 100%;
			left: 0;
			border-radius: 5px;
			overflow: hidden;
		}

			.account-dropdown a {
				color: black;
				padding: 10px 15px;
				display: block;
				text-decoration: none;
			}

				.account-dropdown a:hover {
					background-color: #f1f1f1;
				}

		.user-account-wrapper:hover .account-dropdown {
			display: block;
		}

		.chat-box-container {
			position: fixed;
			bottom: 20px;
			right: 20px;
			width: 300px;
			border-radius: 5px;
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
			z-index: 999;
		}

		.chat-box-header {
			background-color: #ede4da;
			color: #8d7051;
			padding: 10px;
			cursor: pointer;
			text-align: center;
			border-radius: 5px 5px 0 0;
		}

		.chat-box-content {
			background-color: #fff;
			padding: 10px;
			display: none;
			border-radius: 0 0 5px 5px;
			max-height: 400px;
			overflow-y: auto;
		}

			.chat-box-content form textarea {
				width: 100%;
				padding: 10px;
				border-radius: 6px;
				border: 1px solid #ddd;
			}

			.chat-box-content form button {
				width: 100%;
				background-color: #ede4da;
				color: #8d7051;
				padding: 12px 30px;
				border: none;
				border-radius: 30px;
				cursor: pointer;
				font-weight: bold;
				transition: 0.3s ease;
			}

				.chat-box-content form button:hover {
					background-color: #decdbd;
				}
	</style>
</head>

<body>
	<div id="header-wrap">

		<header id="header">
			<div class="container-fluid">
				<div class="row">
					<div class="col-md-2">
						<div class="main-logo">
							<a href="/Home/Index"><img src="~/images/chocolat/Logo.png" width="100" height="100" alt="logo"></a>
						</div>
					</div>
					<div class="col-md-10">
						<nav id="navbar">
							<div class="main-menu stellarnav">
								<ul class="menu-list">
									<li class="menu-item active"><a href="/Home/Index">TRANG CHỦ</a></li>

									<!-- ✅ Đã cập nhật: Thêm menu SẢN PHẨM có submenu -->
									@{
										var categories = _context.Categories.ToList();
									}
									<li class="menu-item has-sub">
										<a href="#" class="nav-link">Danh Mục</a>
										<ul>
											@foreach (var category in categories)
											{
												<li><a href="/Home/Filter?categoryId=@category.Id">@category.Name</a></li>
											}
										</ul>
									</li>

									<li class="menu-item"><a href="/Home/Story" class="nav-link">Tin Tức</a></li>

									<li class="menu-item"><a href="/Home/About" class="nav-link">VỀ ECOLOOM</a></li>
									<li class="menu-item"><a href="/Home/Support" class="nav-link">HỖ TRỢ</a></li>
								</ul>
								<div class="hamburger">
									<span class="bar"></span>
									<span class="bar"></span>
									<span class="bar"></span>
								</div>

							</div>
						</nav>
					</div>
				</div>
			</div>
		</header>

		@* swap *@

		<div class="top-content">
			<div class="container-fluid">
				<div class="row">
					<div class="col-md-6">


						<div class="action-menu">
							<div class="search-bar">
								<a href="#" class="search-button search-toggle" data-selector="#header-wrap">
									<i class="icon icon-search"></i>
								</a>
								<form role="search" method="get" action="/home/filter" class="search-box">
									<input class="search-field text search-input" placeholder="Search" name="keyword" type="search">
								</form>

							</div>
						</div>



					</div>
					<div class="col-md-6">
						<div class="right-element">
							<div class="user-account-wrapper">
								@if (isLoggedIn)
								{
									<a href="#" class="user-account for-buy">
										<i class="icon icon-user"></i><span>Hello @username</span>
									</a>
									<div class="account-dropdown">
										<a href="/Login/Logout">Đăng Xuất</a>
										<a href="/Customer/CustomerEdit">Chỉnh Sửa Thông Tin</a>
										<a href="/Cart/OrderHistory">Lịch Sử Đơn Hàng</a>
									</div>
								}
								else
								{
									<a href="#" class="user-account for-buy">
										<i class="icon icon-user"></i><span>Tài Khoản</span>
									</a>
									<div class="account-dropdown">
										<a href="/Login/Index">Đăng nhập</a>
										<a href="/Register/Index">Đăng ký</a>
									</div>
								}
							</div>
							<a href="/Cart/Index" class="cart for-buy">
								<i class="icon icon-clipboard"></i><span>Giỏ Hàng</span>
							</a>
							
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>

	<div class="container">
		<main role="main" class="pb-3">
			@RenderBody()
		</main>
	</div>

	<div class="chat-box-container">
		<div class="chat-box-header" onclick="toggleChatBox()">
			Chatbox AI
		</div>
		<div class="chat-box-content">
			<div class="chat-messages" id="chatMessages"></div>
			<form id="chatForm" method="post" onsubmit="return false;">
			 
				@Html.AntiForgeryToken()
				<label for="chatUserInput">Đặt câu hỏi:</label>
				<textarea name="chatUserInput" id="chatUserInput" rows="4" cols="50" placeholder="..."></textarea>
				<button type="submit">Gửi</button>
			</form>
		</div>
	</div>

	<footer id="footer">
	</footer>

	<div id="footer-bottom">
		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<div class="copyright">
						<div class="row">
							<div class="col-md-6">
								<p>© 2025 <a href="#" target="_blank">Ecoloom</a></p>
							</div>
							<div class="col-md-6">
								<div class="social-links align-right">
									<ul>
										<li>
											<a href="https://www.facebook.com/profile.php?id=61576870510389&locale=vi_VN" target="_blank" rel="noopener noreferrer">
												<i class="icon icon-facebook"></i>
											</a>
										</li>
										<li>
											<a href="https://www.facebook.com/profile.php?id=61576870510389&locale=vi_VN" target="_blank" rel="noopener noreferrer">
												<i class="icon icon-youtube-play"></i>
											</a>
										</li>

									</ul>
								</div>
							</div>

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="~/js/jquery-1.11.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		function toggleChatBox() {
			var content = document.querySelector('.chat-box-content');
			content.style.display = (content.style.display === 'none' || content.style.display === '') ? 'block' : 'none';
		}

				$(document).ready(function () {
			$('#chatForm').on('submit', function (e) {
				e.preventDefault();
				var userInput = $('#chatUserInput').val().trim();  
				var token = $('#chatForm input[name="__RequestVerificationToken"]').val(); 

				console.log("Submitting form...");
				console.log("User Input:", userInput); 
				 
				if (!userInput || userInput.length === 0) {
					appendMessage('system', 'Vui lòng nhập nội dung.');
					return;
				}

				if (!token) {
					appendMessage('system', 'Lỗi: Không tìm thấy token CSRF. Vui lòng tải lại trang.');
					return;
				}

				appendMessage('user', userInput);   
				 
				console.log("User input after appendMessage:", userInput);

				console.log("Sending AJAX request to /Chat...");

		$.ajax({
			type: 'post',
			url: '/Chat',
			contentType: 'application/json',
			headers: {
				'RequestVerificationToken': token,
				'X-Requested-With': 'XMLHttpRequest'  
			},
			data: JSON.stringify({ userInput: userInput }),  
			dataType: 'json',
			beforeSend: function (xhr) {
				console.log("AJAX request initiated.");
				console.log("Sending Data:", JSON.stringify({ userInput: userInput }));   
			},
			success: function (response) {
				console.log("Full Response:", response);
				var aiResponse = response?.aiResponse || 'Không nhận được phản hồi từ AI.';
				appendMessage('ai', aiResponse);
				$('#chatUserInput').val('');  
			},
			error: function (jqXHR, textStatus, errorThrown) {
				console.error("AJAX Error:", jqXHR, textStatus, errorThrown);
				appendMessage('system', 'Lỗi khi xử lý yêu cầu.');
			}
		});

			});
			 
			function appendMessage(sender, message) {
				var chatMessages = $('#chatMessages');
				var messageClass = sender === 'user' ? 'user-message' : sender === 'ai' ? 'ai-message' : 'system-message';
				var messageHtml = `<div class="${messageClass}"><strong>${sender === 'user' ? 'You' : sender === 'ai' ? 'AI' : 'System'}:</strong> ${message}</div>`;
				chatMessages.append(messageHtml);
				chatMessages.scrollTop(chatMessages[0].scrollHeight);  // Scroll to bottom
			}
		});


	</script>


	<script src="~/js/plugins.js"></script>
	<script src="~/js/script.js"></script>

	@await RenderSectionAsync("Scripts", required: false)
	@RenderSection("Styles", required: false)


</body>
</html>
